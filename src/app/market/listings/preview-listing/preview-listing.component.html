<!--div mat-dialog-title>
  {{data?.listing?.title}}
  <span class="category">
    in {{data?.listing?.category.name}}
  </span>
</div-->

<button class="small-close-button pull-right" (click)="dialogClose()">
  <mat-icon fontSet="partIcon" fontIcon="part-circle-remove"></mat-icon>
</button>

<div mat-dialog-content class="dialog-content">
  <div class="product-summary" fxLayout="row">

    <div class="product-gallery" fxFlex="1 1 450px">
      <div class="gallery-carousel">
        <img
          *ngIf="data?.listing?.imageCollection?.imageItems?.length === 0"
          [src]="data?.listing?.imageCollection?.featuredImage?.thumbnail">

        <gallery
          *ngIf="data?.listing?.imageCollection?.imageItems?.length"
          gallerize
          [gestures]="false"
          [style.height.px]="380"
          [style.width.px]="450"
          [thumbWidth]= "80"
          [thumbHeight]="80"
          [thumb]="data?.listing?.imageCollection?.imageItems?.length > 1"
          [items]="data?.listing?.imageCollection?.imageItems">
        </gallery>
      </div>
    </div><!-- .product-gallery -->

    <div class="product-info" fxFlex="1 1 100%">

      <h1>{{ data?.listing?.title }}</h1>

      <div class="pricing">
        <div class="item price">
          <div class="title">Price</div>
          <div class="value part">
            <span class="big">{{ data?.listing?.basePrice.getIntegerPart() }}</span><span class="big">{{ data?.listing?.basePrice.dot() }}</span><span class="small">{{ data?.listing?.basePrice.getFractionalPart() }}</span>
            <span class="currency">PART</span>
          </div>
          <div class="value fiat">
            <span class="fiat">~ {{price?.usd}} xx EUR</span>
          </div>
        </div>
      </div><!-- .pricing -->

      <p class="summary description">
        {{ data?.listing?.shortDescription }}
      </p>

      <table class="meta">
        <tr>
          <th class="title">
            <mat-icon fontSet="partIcon" fontIcon="part-truck"></mat-icon>
            Shipping
          </th>
          <td class="value">
            {{ data?.listing?.domesticShippingPrice.getAmount() }} &ndash; {{ data?.listing?.internationalShippingPrice.getAmount() }} <small>PART</small>
          </td>
        </tr>
        <tr>
          <th class="title">
            <mat-icon fontSet="partIcon" fontIcon="part-label"></mat-icon>
            Category
          </th>
          <td class="value">
            {{ data?.listing?.category.name }}
          </td>
        </tr>
        <tr>
          <th class="title">
            <mat-icon fontSet="partIcon" fontIcon="part-globe"></mat-icon>
            Sold from
          </th>
          <td class="value">
            {{ countryListService?.getCountryByRegion(data?.listing?.country)?.name }}
            ({{ data?.listing?.country }})
          </td>
        </tr>
        <tr>
          <th class="title">
            <mat-icon fontSet="partIcon" fontIcon="part-date"></mat-icon>
            Date added
          </th>
          <td class="value">
            {{ data?.listing?.createdAt }}
          </td>
        </tr>
      </table>

    </div><!-- .product-info -->
  </div><!-- .product-summary -->

  <div class="product-details">

    <mat-tab-group class="listing-tabs" (selectChange)="changeTab($event.index)">
      <mat-tab label="Details"></mat-tab>
      <mat-tab label="Shipping &amp; Escrow"></mat-tab>
      <mat-tab label="Questions &amp; Answers"></mat-tab>
    </mat-tab-group><!-- .listing-tabs -->


    <div class="tab-content details" *ngIf="tabLabels[selectedTab] == 'details'">
      <h2 class="subtitle">Product info</h2>
      <mat-card>
        <p class="detailed description">{{ data?.listing?.longDescription }}</p>
      </mat-card>
    </div><!-- .tab-content.details -->


    <div class="tab-content shipping" *ngIf="tabLabels[selectedTab] == 'shipping'">
      <h2 class="subtitle">Pricing details</h2>
      <mat-card>
        <table class="shipping-escrow">
          <thead>
            <tr>
              <th>Shipping to</th>
              <th>Shipping</th>
              <th>Escrow</th>
              <th>Total needed for order</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>
                {{ countryListService?.getCountryByRegion(data?.listing?.country)?.name }}
                <small>Shipping carrier</small>
              </th>
              <!-- domestic shipping -->
              <td>
                <span class="part price">
                  <strong>{{ data?.listing?.domesticShippingPrice.getAmount() }}</strong> <small class="currency">PART</small>
                </span>
                <span class="fiat price">
                  &asymp; 0.41 <small class="currency">EUR</small>
                </span>
              </td>
              <!-- domestic escrow -->
              <td>
                <span class="part price">
                  <strong>{{ data?.listing?.escrowPriceDomestic?.getAmount() }}</strong> <small class="currency">PART</small>
                </span>
                <span class="fiat price">
                  &asymp; 0.41 <small class="currency">EUR</small>
                </span>
              </td>
              <!-- domestic total -->
              <td>
                <span class="part price">
                  <strong>{{data?.listing?.totalAmountDomestic?.getAmount()}}</strong> <small class="currency">PART</small>
                </span>
                <span class="fiat price">
                  &asymp; 0.41 <small class="currency">EUR</small>
                </span>
              </td>
            </tr>
            <tr>
              <th>
                Worldwide 
                <small>Shipping carrier</small>
              </th>
              <!-- international shipping -->
              <td>
                <span class="part price">
                  <strong>{{ data?.listing?.internationalShippingPrice.getAmount() }}</strong> <small class="currency">PART</small>
                </span>
                <span class="fiat price">
                  &asymp; 0.41 <small class="currency">EUR</small>
                </span>
              </td>
              <!-- international escrow -->
              <td>
                <span class="part price">
                  <strong>{{ data?.listing?.escrowPriceInternational?.getAmount() }}</strong> <small class="currency">PART</small>
                </span>
                <span class="fiat price">
                  &asymp; 0.41 <small class="currency">EUR</small>
                </span>
              </td>
              <!-- international total -->
              <td>
                <span class="part price">
                  <strong>{{data?.listing?.totalAmountInternaltional?.getAmount()}}</strong> <small class="currency">PART</small>
                </span>
                <span class="fiat price">
                  &asymp; 0.41 <small class="currency">EUR</small>
                </span>
              </td>
            </tr>
            <tr class="help-text">
              <td></td>
              <td>
                <small>Shipping price for 1 item</small>
              </td>
              <td>
                <small>Security deposit (100% of order value) needed for this trade &ndash; it will be refunded after order is completed and delivered</small>
              </td>
              <td>
                <small>Amount of funds needed in total for this trade (incl. the refundable escrow)</small>
              </td>
            </tr>
          </tbody>
        </table><!-- .shipping-escrow -->
      </mat-card>
    </div><!-- .tab-content.shipping-->


    <div class="tab-content comments" *ngIf="tabLabels[selectedTab] == 'questions'" fxLayoutGap="35px">

      <div class="write-comment" fxFlex="1 1 250px">
        <h2 class="subtitle">Ask a question</h2>
        <mat-card>
          <p>
            Write your question here
          </p>
          <button mat-raised-button color="primary">
            <mat-icon fontSet="partIcon" fontIcon="part-chat"></mat-icon>
            Send question
          </button>
        </mat-card>
      </div><!-- .write-comment -->

      <div class="comments-list" fxFlex="0 1 100%">
        <!-- FIXME: count number of all questions, output the amount in tag: -->
        <h2 class="subtitle">All questions &amp; answers <span class="tag">3</span></h2>
        <!-- FIXME: if no questions asked yet: -->
        <!--div class="no-results">
          No questions asked about this product yet
        </div-->

        <!-- FIXME: list all questions for this product (sorted by newest first): -->
        <mat-expansion-panel class="question-box">
          <mat-expansion-panel-header>
            <mat-panel-title fxLayout fxLayoutGap="10px">
              <div class="no">#3</div>
              <div class="summary">
                How much does this weight? My floors can hold just 3 kg of stuff..
              </div>
              <div class="seller-responded">
                <mat-icon fontSet="partIcon" fontIcon="part-check"></mat-icon>
                Seller responded
              </div>
              <!-- FIXME: calculate amount of answers to this question: -->
              <div class="answers-no">
                <span class="tag" matTooltip="3 answers">3</span>
              </div>
            </mat-panel-title>
          </mat-expansion-panel-header>

          <h3 class="question">
            How much does this weight? My floors can hold just 3 kg of stuff..
          </h3>
          <!-- FIXME: list all answers to this question (sorted by oldest first): -->
          <mat-divider></mat-divider>
          <!-- FIXME: add `by-seller` class if answered by Seller: -->
          <div class="answer by-seller">
            <div class="author">
              <span class="tag seller">Seller</span>
            </div>
            <span class="message">
              I have no idea
            </span>
            <!-- FIXME: date in format year-month-day hours-minutes: -->
            <span class="date">2018-12-13 19:24</span>
          </div>
          <mat-divider></mat-divider>
          <!-- FIXME: add `by-user` class if answered by non-seller (normal user): -->
          <div class="answer by-user">
            <div class="author">
              <span class="tag user">User</span>
            </div>
            <span class="message">
              It's like 3.2 kg, sorry mate. Your floors have no chance. What are you doing on Particl Market with those floors anyways?!
            </span>
            <span class="date">2018-12-11 04:33</span>
          </div>

          <!-- FIXME: sending reply to this question only: -->
          <mat-action-row>
            Write a reply:
            <button mat-raised-button color="primary">
              <mat-icon fontSet="partIcon" fontIcon="part-chat"></mat-icon>
              Send
            </button>
          </mat-action-row>
        </mat-expansion-panel>

      </div><!-- .comments-list -->

    </div><!-- .tab-content.comments -->
  </div><!-- .product-details -->

</div><!-- .dialog-content -->


<mat-dialog-actions fxLayoutAlign="space-between center">

  <div class="left">

    <app-report *ngIf="!data?.listing?.isFlagged && !data?.listing?.isMine" [listing]="data?.listing" [from]="'preview'"></app-report>

    <div class="reporting" *ngIf="data?.listing?.isFlagged">
      <!-- Reported, not voted yet by user -->
      <div *ngIf="!data?.listing?.VoteDetails">
        <span class="title"><strong>Item reported</strong> as inappropriate, please vote:</span>
        <button mat-button class="small" color="primary" (click)="voteForListing(data?.listing?.keepItem)" matTooltip="Item is fine and should stay on Market">
          <mat-icon fontSet="partIcon" fontIcon="part-thumb-up"></mat-icon>
        </button>
        <button mat-button class="small" color="warn" (click)="voteForListing(data?.listing?.removeItem)" matTooltip="Item is inappropriate/illegal and should be removed from Market">
          <mat-icon fontSet="partIcon" fontIcon="part-thumb-down"></mat-icon>
        </button>
      </div>
      <!-- Reported & voted already -->
      <div *ngIf="data?.listing?.VoteDetails" class="voted">
        <p *ngIf="data?.listing?.VoteDetails?.isReported">
          <mat-icon fontSet="partIcon" fontIcon="part-flag" class="voted-icon"></mat-icon>
          Thanks for flagging this item as inappropriate
        </p>
        <p *ngIf="!data?.listing?.VoteDetails?.isReported">
          <mat-icon fontSet="partIcon" fontIcon="part-check-in-a-box" class="voted-icon"></mat-icon>
          Thanks for voting on this item
        </p>
      </div>
    </div><!-- .reporting -->

  </div>

  <div class="right" fxLayout fxLayoutAlign="end center">
    <app-favorite [listing]="data?.listing" [detail]="true"></app-favorite>
    <app-add-to-cart [listing]="data?.listing" [detail]="true" (onAdded)="dialogClose()"></app-add-to-cart>

    <!-- if mine, show message instead of "add to cart" button -->
    <button mat-button disabled *ngIf="data?.listing?.isMine">
      <mat-icon fontSet="partIcon" fontIcon="part-circle-info"></mat-icon>
      This is your own listing
    </button>
  </div>

</mat-dialog-actions>
